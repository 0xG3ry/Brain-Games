<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Brain Games üß†</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">

<script>
const SUPABASE_URL = "https://mfolyygzwhsdhuqcuqhd.supabase.co";
const SUPABASE_KEY = "sb_publishable_8o7tRnrAxVrNMDkFPUQ0ww_4890ZZdv";

const SB = {
  async insert(row) {
    try {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/scores`, {
        method: "POST",
        headers: {
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`,
          "Content-Type": "application/json",
          "Prefer": "return=minimal"
        },
        body: JSON.stringify(row)
      });
      return res.ok;
    } catch(e) { return false; }
  },
  async fetchTop(mode, diff) {
    try {
      let url = `${SUPABASE_URL}/rest/v1/scores?select=*&order=score.desc&limit=300`;
      if (mode && mode !== 'all') url += `&mode=eq.${mode}`;
      if (diff && diff !== 'all') url += `&diff=eq.${diff}`;
      const res = await fetch(url, {
        headers: {
          "apikey": SUPABASE_KEY,
          "Authorization": `Bearer ${SUPABASE_KEY}`
        }
      });
      if (!res.ok) return null;
      return await res.json();
    } catch(e) { return null; }
  }
};
</script>

<style>
:root {
  --bg:#07070f;--surface:#0f0f1a;--surface2:#171726;
  --border:rgba(255,255,255,0.07);
  --accent:#f0ff44;--accent2:#ff4466;--accent3:#44ffcc;--accent4:#ff8844;
  --text:#eeeef8;--dim:#55557a;--dim2:#2e2e48;
  --ff:'Syne',sans-serif;--fm:'Space Mono',monospace;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:var(--ff);min-height:100vh;overflow-x:hidden}

.bg-grid{position:fixed;inset:0;z-index:0;
  background-image:linear-gradient(rgba(240,255,68,.02) 1px,transparent 1px),
  linear-gradient(90deg,rgba(240,255,68,.02) 1px,transparent 1px);
  background-size:50px 50px;animation:gMove 25s linear infinite}
@keyframes gMove{to{background-position:50px 50px}}
.orb{position:fixed;border-radius:50%;filter:blur(120px);pointer-events:none;z-index:0;animation:oFloat 10s ease-in-out infinite}
.o1{width:600px;height:600px;background:rgba(240,255,68,.05);top:-200px;right:-150px}
.o2{width:500px;height:500px;background:rgba(255,68,102,.04);bottom:-200px;left:-100px;animation-delay:-5s}
.o3{width:350px;height:350px;background:rgba(68,255,204,.03);top:50%;left:30%;animation-delay:-3s}
@keyframes oFloat{0%,100%{transform:translate(0,0)}50%{transform:translate(40px,-40px)}}

#app{position:relative;z-index:1;min-height:100vh}
.screen{display:none;min-height:100vh;flex-direction:column;align-items:center;justify-content:center;padding:24px 16px}
.screen.active{display:flex}

/* BANNER */
.banner{position:fixed;top:0;left:0;right:0;z-index:500;padding:8px 16px;font-family:var(--fm);font-size:11px;letter-spacing:2px;text-align:center;display:none}
.banner.offline{background:rgba(255,68,68,.15);border-bottom:1px solid rgba(255,68,68,.3);color:#ff6868;display:block}
.banner.online{background:rgba(68,255,204,.1);border-bottom:1px solid rgba(68,255,204,.2);color:var(--accent3);display:block}
.banner.saving{background:rgba(240,255,68,.08);border-bottom:1px solid rgba(240,255,68,.2);color:var(--accent);display:block}

/* SETUP SQL MODAL */
.modal{position:fixed;inset:0;z-index:600;background:rgba(7,7,15,.96);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;padding:24px}
.modal.show{display:flex}
.mbox{max-width:560px;width:100%;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:32px}
.mbox h2{font-size:20px;font-weight:800;color:var(--accent3);margin-bottom:4px}
.msub{font-family:var(--fm);font-size:11px;letter-spacing:3px;color:var(--dim);text-transform:uppercase;margin-bottom:20px}
.mstep{display:flex;gap:12px;margin-bottom:12px;padding:14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px}
.mnum{width:24px;height:24px;border-radius:50%;background:var(--accent3);color:#000;font-weight:800;font-size:12px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.mtxt{font-size:13px;line-height:1.6}
.mtxt code{background:rgba(68,255,204,.1);border:1px solid rgba(68,255,204,.2);padding:2px 6px;border-radius:4px;font-family:var(--fm);font-size:10px;color:var(--accent3)}
.mcopy{width:100%;padding:10px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--accent3);font-family:var(--fm);font-size:10px;line-height:1.8;text-align:left;margin:8px 0;cursor:text;white-space:pre}
.mclose{width:100%;padding:14px;margin-top:8px;background:var(--accent3);border:none;border-radius:8px;color:#000;font-family:var(--ff);font-size:16px;font-weight:800;cursor:pointer;transition:all .2s}
.mclose:hover{opacity:.9}

/* HOME */
.logo-area{text-align:center;margin-bottom:36px}
.brain{font-size:72px;display:block;animation:bPulse 3s ease-in-out infinite;filter:drop-shadow(0 0 30px rgba(240,255,68,.7))}
@keyframes bPulse{0%,100%{transform:scale(1) rotate(-3deg)}50%{transform:scale(1.08) rotate(3deg)}}
.title{font-size:clamp(48px,10vw,96px);font-weight:800;letter-spacing:-3px;line-height:1;
  background:linear-gradient(135deg,var(--accent) 0%,#fff 45%,var(--accent3) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.tagline{font-family:var(--fm);font-size:11px;letter-spacing:6px;color:var(--dim);text-transform:uppercase;margin-top:8px}

.lang-row{display:flex;gap:6px;margin-bottom:24px}
.lpill{padding:6px 16px;border:1px solid var(--border);border-radius:20px;background:transparent;color:var(--dim);font-family:var(--fm);font-size:11px;font-weight:700;letter-spacing:2px;cursor:pointer;transition:all .2s}
.lpill:hover{border-color:var(--accent3);color:var(--accent3)}
.lpill.active{background:var(--accent3);border-color:var(--accent3);color:#000}

.name-wrap{width:100%;max-width:420px;margin-bottom:28px}
.nlabel{font-family:var(--fm);font-size:10px;letter-spacing:4px;color:var(--accent);text-transform:uppercase;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.nlabel::before{content:'';width:16px;height:1px;background:var(--accent)}
.ninput{width:100%;padding:16px 20px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;color:var(--text);font-family:var(--ff);font-size:22px;font-weight:700;outline:none;transition:all .2s}
.ninput:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(240,255,68,.1)}
.ninput::placeholder{color:var(--dim)}

.mode-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;width:100%;max-width:640px;margin-bottom:20px}
.mcard{padding:20px;background:var(--surface);border:1px solid var(--border);border-radius:12px;cursor:pointer;transition:all .25s;text-align:left;position:relative;overflow:hidden}
.mcard:hover{transform:translateY(-3px);border-color:rgba(255,255,255,.15)}
.mcard.sel{border-color:var(--accent);box-shadow:0 0 0 2px rgba(240,255,68,.12)}
.mcard.sel::after{content:'‚úì';position:absolute;top:12px;right:12px;width:22px;height:22px;background:var(--accent);color:#000;font-size:11px;font-weight:800;border-radius:50%;line-height:22px;text-align:center}
.mcard[data-m="infinite"].sel{border-color:var(--accent2);box-shadow:0 0 0 2px rgba(255,68,102,.12)}
.mcard[data-m="infinite"].sel::after{background:var(--accent2)}
.micon{font-size:26px;margin-bottom:10px;display:block}
.mname{font-size:15px;font-weight:800;margin-bottom:4px}
.mdesc{font-family:var(--fm);font-size:11px;color:var(--dim);line-height:1.5}

.diff-row{display:flex;gap:8px;width:100%;max-width:640px;margin-bottom:28px}
.dchip{flex:1;padding:10px;background:var(--surface);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-family:var(--fm);font-size:11px;font-weight:700;letter-spacing:2px;color:var(--dim);text-transform:uppercase;text-align:center;transition:all .2s}
.dchip:hover{color:var(--text);border-color:rgba(255,255,255,.15)}
.dchip.active{color:#000;background:var(--accent);border-color:var(--accent)}
.dchip[data-d="medium"].active{background:var(--accent4);border-color:var(--accent4)}
.dchip[data-d="hard"].active{background:var(--accent2);border-color:var(--accent2)}

.start-btn{width:100%;max-width:640px;padding:20px;background:var(--accent);border:none;border-radius:12px;color:#000;font-family:var(--ff);font-size:20px;font-weight:800;cursor:pointer;transition:all .2s}
.start-btn:hover{transform:translateY(-2px);box-shadow:0 10px 40px rgba(240,255,68,.3)}
.start-btn:disabled{opacity:.3;cursor:not-allowed;transform:none}

.home-btns-row{display:flex;gap:10px;margin-top:14px;width:100%;max-width:640px}
.sec-btn{flex:1;padding:13px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--dim);font-family:var(--fm);font-size:11px;letter-spacing:2px;cursor:pointer;transition:all .2s;text-transform:uppercase}
.sec-btn:hover{border-color:var(--accent3);color:var(--accent3)}

/* GAME */
#game-screen{justify-content:flex-start;padding:0}
.gwrap{width:100%;max-width:720px;margin:0 auto;padding:16px}
.topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 0 16px;border-bottom:1px solid var(--border);margin-bottom:14px}
.ptag{display:flex;align-items:center;gap:10px}
.pav{width:36px;height:36px;border-radius:50%;font-weight:800;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.pname{font-weight:700;font-size:15px}
.pmode{font-family:var(--fm);font-size:10px;letter-spacing:2px;color:var(--dim);margin-top:2px}
.hud{display:flex;gap:16px;align-items:center}
.hblock{text-align:right}
.hval{font-family:var(--fm);font-size:20px;font-weight:700;line-height:1}
.hval.sc{color:var(--accent)}
.hlbl{font-size:10px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-top:2px}
.qbtn{background:transparent;border:none;cursor:pointer;color:var(--dim);font-family:var(--fm);font-size:11px;letter-spacing:2px;text-transform:uppercase;padding:6px 12px;transition:color .2s}
.qbtn:hover{color:var(--accent2)}

.tcont{margin-bottom:12px}
.tmeta{display:flex;justify-content:space-between;margin-bottom:5px}
.tlabel{font-family:var(--fm);font-size:11px;color:var(--dim);letter-spacing:2px}
.tval{font-family:var(--fm);font-size:14px;font-weight:700}
.tval.ok{color:var(--accent3)}.tval.warn{color:var(--accent4)}.tval.danger{color:var(--accent2)}
.ttrack{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden}
.tfill{height:100%;border-radius:4px;transition:width .1s linear}
.tfill.ok{background:linear-gradient(90deg,var(--accent3),var(--accent))}
.tfill.warn{background:linear-gradient(90deg,var(--accent4),#ffcc00)}
.tfill.danger{background:linear-gradient(90deg,var(--accent2),#ff0044);animation:dp .4s ease-in-out infinite}
@keyframes dp{0%,100%{opacity:1}50%{opacity:.5}}

.sbar{display:flex;align-items:center;gap:10px;padding:8px 14px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:12px;transition:all .3s}
.sbar.hot{border-color:var(--accent4);background:rgba(255,136,68,.05)}
.sfire{font-size:17px;animation:fw .5s ease-in-out infinite alternate}
@keyframes fw{from{transform:rotate(-5deg)}to{transform:rotate(5deg)}}
.slabel{font-family:var(--fm);font-size:11px;color:var(--dim);letter-spacing:1px;flex:1}
.sdots{display:flex;gap:4px}
.sdot{width:14px;height:14px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);transition:all .3s}
.sdot.lit{background:var(--accent4);border-color:var(--accent4);box-shadow:0 0 8px rgba(255,136,68,.5)}
.sdot.lit.bonus{background:var(--accent2);border-color:var(--accent2);box-shadow:0 0 12px rgba(255,68,102,.6);transform:scale(1.3)}
.smult{font-family:var(--fm);font-size:11px;color:var(--accent2);background:rgba(255,68,102,.1);border:1px solid rgba(255,68,102,.3);padding:3px 8px;border-radius:4px;opacity:0;transition:opacity .3s;font-weight:700}
.smult.show{opacity:1}

.qprog{margin-bottom:12px}
.qrow{display:flex;justify-content:space-between;margin-bottom:5px}
.qlabel{font-family:var(--fm);font-size:11px;color:var(--dim);letter-spacing:2px}
.qdots-wrap{display:flex;gap:3px;flex-wrap:wrap}
.qdot{width:8px;height:8px;border-radius:50%;background:var(--dim2);transition:all .3s}
.qdot.done{background:var(--accent3)}.qdot.cur{background:var(--accent);box-shadow:0 0 8px rgba(240,255,68,.5)}.qdot.bad{background:var(--accent2)}

.pcard{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:28px;position:relative;overflow:hidden;margin-bottom:12px}
.pcard::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:linear-gradient(90deg,var(--accent),var(--accent3),var(--accent2),var(--accent4));background-size:300% 100%;animation:gf 3s linear infinite}
@keyframes gf{from{background-position:0%}to{background-position:300%}}
.tbadge{display:inline-flex;align-items:center;gap:6px;font-family:var(--fm);font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--dim);border:1px solid var(--border);padding:4px 12px;border-radius:20px;margin-bottom:14px;background:rgba(255,255,255,.02)}
.qnum-badge{position:absolute;top:20px;right:24px;font-family:var(--fm);font-size:11px;color:var(--dim2)}
.pq{font-size:clamp(17px,2.5vw,22px);font-weight:700;line-height:1.5;margin-bottom:18px}
.pvis{background:rgba(0,0,0,.4);border:1px solid rgba(255,255,255,.06);border-radius:10px;padding:16px 20px;margin-bottom:18px;font-family:var(--fm);font-size:clamp(18px,3vw,26px);text-align:center;color:var(--accent);letter-spacing:4px;line-height:1.4}
.opts{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.opt{padding:14px 16px;background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.08);border-radius:10px;color:var(--text);font-family:var(--ff);font-size:15px;font-weight:600;cursor:pointer;text-align:left;transition:all .18s;display:flex;align-items:center;gap:10px}
.olet{width:22px;height:22px;border-radius:4px;background:var(--surface2);font-family:var(--fm);font-size:10px;font-weight:700;color:var(--dim);flex-shrink:0;display:flex;align-items:center;justify-content:center;transition:all .18s}
.opt:hover:not(:disabled){border-color:rgba(255,255,255,.2);background:rgba(255,255,255,.05);transform:translateY(-1px)}
.opt:hover:not(:disabled) .olet{background:var(--accent);color:#000}
.opt.correct{border-color:var(--accent3)!important;background:rgba(68,255,204,.08)!important;color:var(--accent3)}
.opt.correct .olet{background:var(--accent3);color:#000}
.opt.wrong{border-color:var(--accent2)!important;background:rgba(255,68,102,.08)!important;color:var(--accent2)}
.opt.wrong .olet{background:var(--accent2);color:#fff}
.opt:disabled{cursor:default}

.toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%);padding:11px 24px;border-radius:10px;font-family:var(--fm);font-size:13px;font-weight:700;letter-spacing:1px;z-index:400;pointer-events:none;opacity:0;transition:all .3s;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(-10px)}
.toast.ok{background:rgba(68,255,204,.12);border:1px solid var(--accent3);color:var(--accent3)}
.toast.err{background:rgba(255,68,102,.12);border:1px solid var(--accent2);color:var(--accent2)}
.spop{position:fixed;pointer-events:none;z-index:400;font-family:var(--fm);font-size:20px;font-weight:700;animation:spopA 1.2s ease-out forwards}
@keyframes spopA{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-80px)}}
.tadd{position:fixed;top:28%;left:50%;transform:translateX(-50%);font-family:var(--fm);font-size:22px;font-weight:700;color:var(--accent3);pointer-events:none;z-index:400;opacity:0}
.tadd.show{animation:taddA 1s ease-out forwards}
@keyframes taddA{0%{opacity:1;transform:translateX(-50%) translateY(0)}100%{opacity:0;transform:translateX(-50%) translateY(-60px) scale(1.4)}}
.combo-ov{position:fixed;inset:0;z-index:300;display:flex;align-items:center;justify-content:center;pointer-events:none;opacity:0}
.combo-ov.show{animation:cshow 1.5s ease-out forwards}
@keyframes cshow{0%{opacity:0}10%{opacity:1}70%{opacity:1}100%{opacity:0}}
.ctxt{font-size:clamp(48px,10vw,90px);font-weight:800;letter-spacing:-2px;text-align:center;background:linear-gradient(135deg,var(--accent2),var(--accent4));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 30px rgba(255,68,102,.5));animation:ctxtA 1.5s ease-out forwards}
@keyframes ctxtA{0%{transform:scale(.5) rotate(-5deg)}20%{transform:scale(1.1) rotate(2deg)}50%{transform:scale(1)}100%{transform:scale(1.15)}}

/* LEADERBOARD */
#lb-screen{padding:24px 16px 48px}
.lbwrap{width:100%;max-width:620px}
.lbtop{text-align:center;margin-bottom:32px}
.lbtitle{font-size:clamp(36px,7vw,64px);font-weight:800;letter-spacing:-2px;margin-bottom:6px}
.lbsub{font-family:var(--fm);font-size:11px;letter-spacing:4px;color:var(--dim);text-transform:uppercase}
.live-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:var(--accent3);margin-right:6px;animation:ldot 1.5s ease-in-out infinite}
@keyframes ldot{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(.6)}}
.lbtabs{display:flex;gap:4px;margin-bottom:20px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:4px}
.lbtab{flex:1;padding:9px;background:transparent;border:none;border-radius:7px;color:var(--dim);font-family:var(--fm);font-size:10px;letter-spacing:2px;cursor:pointer;transition:all .2s;text-transform:uppercase}
.lbtab.active{background:var(--accent);color:#000;font-weight:700}
.lbe{display:flex;align-items:center;gap:12px;padding:13px 16px;background:var(--surface);border:1px solid var(--border);border-radius:10px;margin-bottom:7px;transition:all .2s;animation:sin .3s ease-out both}
.lbe:hover{border-color:rgba(255,255,255,.12);transform:translateX(4px)}
@keyframes sin{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
.lbe.me{border-color:var(--accent);background:rgba(240,255,68,.03)}
.lrank{font-family:var(--fm);font-size:13px;font-weight:700;width:26px;text-align:center;color:var(--dim);flex-shrink:0}
.lrank.r1{font-size:18px}.lrank.r2{font-size:16px}.lrank.r3{font-size:15px}
.lav{width:36px;height:36px;border-radius:50%;font-weight:800;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.linfo{flex:1;min-width:0}
.lpn{font-weight:700;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.lmeta{font-family:var(--fm);font-size:10px;color:var(--dim);margin-top:2px;letter-spacing:1px}
.lsc{font-family:var(--fm);font-size:18px;font-weight:700;color:var(--accent)}
.youbadge{font-size:9px;letter-spacing:2px;background:var(--accent);color:#000;padding:2px 6px;border-radius:3px;font-weight:700;font-family:var(--fm)}
.lb-empty{text-align:center;padding:48px;color:var(--dim);font-family:var(--fm);font-size:12px;letter-spacing:2px;line-height:2}
.lb-loading{text-align:center;padding:32px;color:var(--dim);font-family:var(--fm);font-size:12px;letter-spacing:3px}
.backbtn{margin-top:20px;background:transparent;border:1px solid var(--border);border-radius:8px;padding:12px 32px;color:var(--dim);font-family:var(--fm);font-size:11px;letter-spacing:2px;cursor:pointer;transition:all .2s}
.backbtn:hover{border-color:var(--accent);color:var(--accent)}

/* RESULTS */
#results-screen{text-align:center}
.remi{font-size:72px;margin-bottom:12px;animation:rb .6s cubic-bezier(.34,1.56,.64,1) both}
@keyframes rb{from{opacity:0;transform:scale(.3)}to{opacity:1;transform:scale(1)}}
.rtitle{font-size:clamp(38px,8vw,72px);font-weight:800;letter-spacing:-2px;margin-bottom:6px}
.rtitle.win{color:var(--accent)}.rtitle.over{color:var(--accent2)}
.rsub{font-family:var(--fm);font-size:11px;letter-spacing:4px;color:var(--dim);margin-bottom:28px;text-transform:uppercase}
.sgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;width:100%;max-width:600px;margin-bottom:24px}
.stile{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px 12px;text-align:center;position:relative;overflow:hidden}
.stile::before{content:'';position:absolute;top:0;left:0;right:0;height:2px}
.stile.t1::before{background:var(--accent)}.stile.t2::before{background:var(--accent3)}.stile.t3::before{background:var(--accent4)}.stile.t4::before{background:var(--accent2)}
.sbig{font-family:var(--fm);font-size:clamp(20px,4vw,28px);font-weight:700;line-height:1}
.stile.t1 .sbig{color:var(--accent)}.stile.t2 .sbig{color:var(--accent3)}.stile.t3 .sbig{color:var(--accent4)}.stile.t4 .sbig{color:var(--accent2)}
.slbl{font-family:var(--fm);font-size:9px;letter-spacing:2px;color:var(--dim);text-transform:uppercase;margin-top:5px}
.rrank{width:100%;max-width:560px;margin-bottom:24px;background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:18px 22px;display:flex;align-items:center;gap:16px}
.rrnum{font-family:var(--fm);font-size:44px;font-weight:700;color:var(--accent)}
.rrtitle{font-weight:700;font-size:17px;margin-bottom:4px}
.rrsub{font-family:var(--fm);font-size:10px;color:var(--dim);letter-spacing:1px}
.rbtns{display:flex;flex-direction:column;gap:10px;width:100%;max-width:400px}
.rpbtn{padding:18px;background:var(--accent);border:none;border-radius:10px;color:#000;font-family:var(--ff);font-size:17px;font-weight:800;cursor:pointer;transition:all .2s}
.rpbtn:hover{transform:translateY(-2px);box-shadow:0 10px 40px rgba(240,255,68,.3)}
.rlbtn{padding:13px;background:transparent;border:1px solid var(--border);border-radius:10px;color:var(--dim);font-family:var(--fm);font-size:11px;letter-spacing:2px;cursor:pointer;transition:all .2s}
.rlbtn:hover{border-color:var(--accent3);color:var(--accent3)}

@media(max-width:500px){
  .mode-grid,.sgrid{grid-template-columns:1fr 1fr}
  .opts{grid-template-columns:1fr}
  .hud{gap:8px}
}
</style>
</head>
<body>
<div class="bg-grid"></div>
<div class="orb o1"></div><div class="orb o2"></div><div class="orb o3"></div>
<div class="banner" id="banner"></div>

<!-- SQL setup modal -->
<div class="modal" id="sql-modal">
  <div class="mbox">
    <h2>üóÑÔ∏è Crear tabla en Supabase</h2>
    <div class="msub">Solo la primera vez ¬∑ 1 minuto</div>
    <div class="mstep"><div class="mnum">1</div><div class="mtxt">Ve a <code>supabase.com</code> ‚Üí tu proyecto ‚Üí <code>SQL Editor</code> ‚Üí <code>New query</code></div></div>
    <div class="mstep"><div class="mnum">2</div><div class="mtxt">Pega este SQL y pulsa <code>Run</code>:</div></div>
    <div class="mcopy" id="sql-copy">CREATE TABLE scores (
  id bigint generated always as identity primary key,
  name text not null,
  score integer not null,
  correct integer, total integer,
  mode text, diff text,
  streak integer, time integer, ts bigint,
  created_at timestamptz default now()
);
ALTER TABLE scores ENABLE ROW LEVEL SECURITY;
CREATE POLICY "read" ON scores FOR SELECT USING (true);
CREATE POLICY "insert" ON scores FOR INSERT WITH CHECK (true);</div>
    <div class="mstep"><div class="mnum">3</div><div class="mtxt">¬°Listo! Vuelve aqu√≠ y juega üéÆ</div></div>
    <button class="mclose" onclick="closeModal()">Entendido ‚úì</button>
  </div>
</div>

<div id="app">

<!-- HOME -->
<div id="home-screen" class="screen active">
  <div class="logo-area">
    <span class="brain">üß†</span>
    <div class="title">BRAIN GAMES</div>
    <div class="tagline">¬øQui√©n es el m√°s listo de la clase?</div>
  </div>
  <div class="lang-row">
    <button class="lpill active" onclick="setLang('es')">ES</button>
    <button class="lpill" onclick="setLang('en')">EN</button>
    <button class="lpill" onclick="setLang('fr')">FR</button>
    <button class="lpill" onclick="setLang('de')">DE</button>
  </div>
  <div class="name-wrap">
    <div class="nlabel">Tu nombre</div>
    <input class="ninput" id="ninput" type="text" placeholder="Escribe tu nombre..." maxlength="20" autocomplete="off" oninput="onName()">
  </div>
  <div class="mode-grid">
    <div class="mcard sel" data-m="classic" onclick="selMode('classic')">
      <span class="micon">üéØ</span>
      <div class="mname">Cl√°sico</div>
      <div class="mdesc">10 preguntas ¬∑ 3 vidas ¬∑ Punt√∫a por velocidad</div>
    </div>
    <div class="mcard" data-m="infinite" onclick="selMode('infinite')">
      <span class="micon">‚ôæÔ∏è</span>
      <div class="mname" style="color:var(--accent2)">Infinito</div>
      <div class="mdesc">Sin fin ¬∑ Temporizador ¬∑ Cada acierto suma tiempo</div>
    </div>
  </div>
  <div class="diff-row">
    <button class="dchip active" data-d="easy" onclick="setDiff('easy')">F√°cil</button>
    <button class="dchip" data-d="medium" onclick="setDiff('medium')">Medio</button>
    <button class="dchip" data-d="hard" onclick="setDiff('hard')">Dif√≠cil</button>
  </div>
  <button class="start-btn" id="start-btn" onclick="startGame()" disabled>‚ñ∂ JUGAR</button>
  <div class="home-btns-row">
    <button class="sec-btn" onclick="showLB()">üèÜ Ranking Global</button>
    <button class="sec-btn" onclick="openModal()">üóÑÔ∏è Setup DB</button>
  </div>
</div>

<!-- GAME -->
<div id="game-screen" class="screen">
  <div class="gwrap">
    <div class="topbar">
      <div class="ptag">
        <div class="pav" id="pav">?</div>
        <div>
          <div class="pname" id="pname-d">Jugador</div>
          <div class="pmode" id="pmode-d"></div>
        </div>
      </div>
      <div class="hud">
        <div class="hblock" id="lives-block">
          <div class="hval" id="lives-d">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</div>
          <div class="hlbl">Vidas</div>
        </div>
        <div class="hblock">
          <div class="hval sc" id="score-d">0</div>
          <div class="hlbl">Score</div>
        </div>
        <button class="qbtn" onclick="quitGame()">‚úï</button>
      </div>
    </div>
    <div class="tcont" id="tcont" style="display:none">
      <div class="tmeta">
        <span class="tlabel">‚è± TIEMPO</span>
        <span class="tval ok" id="tval-d">30.0s</span>
      </div>
      <div class="ttrack"><div class="tfill ok" id="tfill"></div></div>
    </div>
    <div class="sbar" id="sbar">
      <span class="sfire" id="sfire">‚ú®</span>
      <span class="slabel" id="slabel">Racha: 0</span>
      <div class="sdots">
        <div class="sdot"></div><div class="sdot"></div><div class="sdot"></div>
        <div class="sdot"></div><div class="sdot"></div>
      </div>
      <span class="smult" id="smult"></span>
    </div>
    <div id="cprog" class="qprog">
      <div class="qrow">
        <span class="qlabel" id="qlabel">Pregunta 1/10</span>
        <span class="qlabel" id="qcorrect">0 correctas</span>
      </div>
      <div class="qdots-wrap" id="qdots"></div>
    </div>
    <div class="pcard" id="pcard">
      <div class="qnum-badge" id="qnum-badge"></div>
      <div class="tbadge" id="tbadge">L√≥gica</div>
      <div class="pq" id="pq"></div>
      <div class="pvis" id="pvis" style="display:none"></div>
      <div class="opts" id="opts"></div>
    </div>
  </div>
</div>

<!-- LEADERBOARD -->
<div id="lb-screen" class="screen">
  <div class="lbwrap">
    <div class="lbtop">
      <div class="lbtitle">üèÜ RANKING</div>
      <div class="lbsub"><span class="live-dot"></span>Tiempo real ¬∑ Supabase</div>
    </div>
    <div class="lbtabs">
      <button class="lbtab active" onclick="switchTab('all')">Todos</button>
      <button class="lbtab" onclick="switchTab('classic')">Cl√°sico</button>
      <button class="lbtab" onclick="switchTab('infinite')">Infinito</button>
      <button class="lbtab" onclick="switchTab('easy')">F√°cil</button>
      <button class="lbtab" onclick="switchTab('hard')">Dif√≠cil</button>
    </div>
    <div id="lblist"></div>
    <button class="backbtn" onclick="goHome()">‚Üê Volver</button>
  </div>
</div>

<!-- RESULTS -->
<div id="results-screen" class="screen">
  <div class="remi" id="remi">üèÜ</div>
  <div class="rtitle win" id="rtitle">¬°COMPLETADO!</div>
  <div class="rsub" id="rsub"></div>
  <div class="sgrid">
    <div class="stile t1"><div class="sbig" id="rs-score">0</div><div class="slbl">Puntos</div></div>
    <div class="stile t2"><div class="sbig" id="rs-correct">0</div><div class="slbl">Correctas</div></div>
    <div class="stile t3"><div class="sbig" id="rs-streak">0</div><div class="slbl">Racha M√°x</div></div>
    <div class="stile t4"><div class="sbig" id="rs-extra">0s</div><div class="slbl" id="rs-extra-lbl">Tiempo</div></div>
  </div>
  <div class="rrank">
    <div class="rrnum" id="rr-num">#?</div>
    <div>
      <div class="rrtitle" id="rr-title">Calculando...</div>
      <div class="rrsub" id="rr-sub">ranking global</div>
    </div>
  </div>
  <div class="rbtns">
    <button class="rpbtn" onclick="startGame()">‚ñ∂ JUGAR DE NUEVO</button>
    <button class="rlbtn" onclick="showLB()">üèÜ Ver Ranking Completo</button>
    <button class="rlbtn" onclick="goHome()">‚Üê Cambiar Jugador</button>
  </div>
</div>

</div>

<div class="combo-ov" id="combo-ov"><div class="ctxt" id="ctxt">üî•</div></div>
<div class="toast" id="toast"></div>
<div class="tadd" id="tadd"></div>

<script>
// ============================================================
// PUZZLES
// ============================================================
const PZ = {
  es:{
    easy:[
      {t:'math',q:'¬øCu√°nto es 7 √ó 8?',v:'7 √ó 8 = ?',o:['54','56','63','64'],a:'56'},
      {t:'logic',q:'Si tienes 10 manzanas y regalas 4, ¬øcu√°ntas quedan?',o:['5','6','7','8'],a:'6'},
      {t:'riddle',q:'Tengo ciudades pero no casas, monta√±as pero no √°rboles. ¬øQu√© soy?',o:['Un sue√±o','Un mapa','Un cuadro','Una nube'],a:'Un mapa'},
      {t:'math',q:'¬øCu√°l es la mitad de 48?',o:['20','22','24','26'],a:'24'},
      {t:'logic',q:'¬øCu√°l sigue? 2, 4, 8, 16, ...',v:'2‚Üí4‚Üí8‚Üí16‚Üí?',o:['24','28','32','36'],a:'32'},
      {t:'riddle',q:'Cuanto m√°s me sacas, m√°s grande soy. ¬øQu√© soy?',o:['Una pelota','Un hoyo','Una sombra','Un globo'],a:'Un hoyo'},
      {t:'math',q:'¬øCu√°nto es 15 + 27?',v:'15 + 27 = ?',o:['40','41','42','43'],a:'42'},
      {t:'logic',q:'¬øCu√°ntas patas tienen 3 perros y 2 p√°jaros?',o:['14','16','13','17'],a:'16'},
      {t:'math',q:'¬øCu√°nto es 6¬≤?',v:'6¬≤ = ?',o:['30','36','42','48'],a:'36'},
      {t:'riddle',q:'Tengo un ojo pero no puedo ver. ¬øQu√© soy?',o:['Un robot','Una aguja','Un cicl√≥n','Un telescopio'],a:'Una aguja'},
      {t:'math',q:'¬øCu√°nto es 100 √∑ 4?',v:'100 √∑ 4 = ?',o:['20','25','30','40'],a:'25'},
      {t:'word',q:'¬øCu√°l es el ant√≥nimo de "oscuro"?',o:['Negro','Gris','Claro','Noche'],a:'Claro'},
      {t:'logic',q:'¬øCu√°ntas esquinas tiene un cubo?',o:['6','8','10','12'],a:'8'},
      {t:'riddle',q:'Por la ma√±ana en 4 patas, al mediod√≠a en 2, por la noche en 3. ¬øQu√© soy?',o:['Un animal','El hombre','El tiempo','La luna'],a:'El hombre'},
      {t:'math',q:'¬øCu√°nto es 9 √ó 9?',v:'9 √ó 9 = ?',o:['72','81','90','99'],a:'81'},
    ],
    medium:[
      {t:'logic',q:'Si adelantas al segundo en una carrera, ¬øen qu√© puesto quedas?',o:['Primero','Segundo','Tercero','√öltimo'],a:'Segundo'},
      {t:'riddle',q:'Un hombre mira un retrato: "No tengo hermanos, pero el padre de este hombre es hijo de mi padre." ¬øQui√©n es?',o:['Su t√≠o','Su primo','Su hijo','√âl mismo'],a:'Su hijo'},
      {t:'math',q:'Si el 30% de X es 90, ¬øcu√°nto es X?',v:'30%√óX=90',o:['270','300','330','360'],a:'300'},
      {t:'logic',q:'¬øCu√°l sigue? 2, 6, 18, 54, ...',v:'2‚Üí6‚Üí18‚Üí54‚Üí?',o:['108','162','216','270'],a:'162'},
      {t:'math',q:'¬øCu√°nto es ‚àö144 + ‚àö25?',v:'‚àö144 + ‚àö25 = ?',o:['17','19','21','23'],a:'17'},
      {t:'logic',q:'¬øCu√°ntos meses tienen 28 d√≠as?',o:['1','2','6','12'],a:'12'},
      {t:'math',q:'¬øCu√°nto es 2¬π‚Å∞?',v:'2¬π‚Å∞ = ?',o:['512','1024','2048','4096'],a:'1024'},
      {t:'riddle',q:'Habla sin boca, escucha sin o√≠dos, cobra vida con el viento. ¬øQu√© es?',o:['Un fantasma','Un eco','Una sombra','El tiempo'],a:'Un eco'},
      {t:'math',q:'¬øCu√°ntos cuadrados hay en una cuadr√≠cula 3√ó3?',v:'Cuadr√≠cula 3√ó3',o:['9','12','14','16'],a:'14'},
      {t:'logic',q:'Un reloj marca 3:15. ¬øCu√°ntos grados entre manecillas?',v:'üïí 3:15',o:['7.5¬∞','0¬∞','15¬∞','22.5¬∞'],a:'7.5¬∞'},
      {t:'math',q:'¬øCu√°nto es 13¬≤ ‚àí 100?',v:'13¬≤‚àí100=?',o:['49','59','69','79'],a:'69'},
      {t:'riddle',q:'Tengo cabeza y cola pero no tengo cuerpo. ¬øQu√© soy?',o:['Una serpiente','Una moneda','Una cometa','Un r√≠o'],a:'Una moneda'},
      {t:'math',q:'¬øCu√°nto es 3! + 4!?',v:'3! + 4! = ?',o:['24','30','36','42'],a:'30'},
      {t:'logic',q:'¬øCu√°ntos tri√°ngulos en una estrella de David?',v:'‚ú°',o:['6','8','12','16'],a:'8'},
      {t:'riddle',q:'Cuanto m√°s r√°pido corres, menos me ves. ¬øQu√© soy?',o:['El tiempo','Tu sombra','El viento','Tu respiraci√≥n'],a:'Tu respiraci√≥n'},
    ],
    hard:[
      {t:'math',q:'¬øCu√°nto es 999¬≤?',v:'999¬≤=?',o:['997001','998001','999001','996001'],a:'998001'},
      {t:'logic',q:'3 cajas mal etiquetadas. Sacas 1 de "Mixta". ¬øPuedes identificar las 3?',o:['S√≠, siempre','No, nunca','Solo a veces','Con 2 frutas'],a:'S√≠, siempre'},
      {t:'riddle',q:'Soy el principio de todo, el fin del tiempo y del espacio. ¬øQu√© soy?',o:['La nada','El cero','La letra E','El universo'],a:'La letra E'},
      {t:'math',q:'¬øCu√°ntos ceros finales tiene 100!?',v:'100!=?00...',o:['20','22','24','26'],a:'24'},
      {t:'math',q:'¬øCu√°l es el n√∫mero primo entre 90 y 100?',v:'90<P<100',o:['91','93','97','99'],a:'97'},
      {t:'logic',q:'f(x)=x¬≤+2x+1. ¬øCu√°nto es f(5)?',v:'f(5)=?',o:['34','36','38','40'],a:'36'},
      {t:'math',q:'¬øCu√°nto es 7!?',v:'7!=?',o:['2520','4040','5040','6040'],a:'5040'},
      {t:'riddle',q:'Un padre tiene 5 hijos. La mitad son ni√±as. ¬øC√≥mo?',o:['Imposible','Todos son ni√±as','Solo 2 ni√±as','Las 5 son ni√±as'],a:'Las 5 son ni√±as'},
      {t:'math',q:'¬øCu√°nto es log‚ÇÇ(1024)?',v:'log‚ÇÇ(1024)=?',o:['8','10','12','16'],a:'10'},
      {t:'math',q:'Suma de √°ngulos interiores de un hex√°gono.',v:'Hex√°gono',o:['540¬∞','660¬∞','720¬∞','840¬∞'],a:'720¬∞'},
      {t:'math',q:'¬øCu√°nto es 1+2+3+...+100?',v:'Œ£(1‚Üí100)=?',o:['4950','5000','5050','5100'],a:'5050'},
      {t:'logic',q:'En una isla la mitad mienten siempre. Preguntas si son mentirosos. ¬øQu√© responden?',o:['S√≠','No','No s√©','Depende'],a:'No'},
      {t:'math',q:'¬øCu√°nto es i¬≤ (i=‚àö‚àí1)?',v:'i¬≤=?',o:['1','0','-1','i'],a:'-1'},
      {t:'riddle',q:'Tres m√©dicos dicen que Pedro es su hermano, pero Pedro no tiene hermanos. ¬øQui√©n miente?',o:['Los m√©dicos','Pedro','Ambos','Ninguno'],a:'Ninguno'},
      {t:'math',q:'¬øCu√°nto es 17¬≤?',v:'17¬≤=?',o:['279','289','299','309'],a:'289'},
    ]
  },
  en:{
    easy:[
      {t:'math',q:'What is 9 √ó 7?',v:'9√ó7=?',o:['56','63','64','72'],a:'63'},
      {t:'riddle',q:'I speak without a mouth, hear without ears. What am I?',o:['A ghost','An echo','A shadow','A dream'],a:'An echo'},
      {t:'math',q:'What is 144 √∑ 12?',v:'144√∑12=?',o:['10','11','12','13'],a:'12'},
      {t:'logic',q:'Which shape has the most sides?',o:['Triangle','Pentagon','Hexagon','Square'],a:'Hexagon'},
      {t:'riddle',q:'The more you take, the more you leave behind. What am I?',o:['Breath','Footsteps','Time','Words'],a:'Footsteps'},
      {t:'math',q:'What is 50% of 84?',v:'50%√ó84=?',o:['38','40','42','44'],a:'42'},
      {t:'logic',q:'What comes next? 3, 6, 9, 12, ...',v:'3‚Üí6‚Üí9‚Üí12‚Üí?',o:['13','14','15','16'],a:'15'},
      {t:'riddle',q:'I have a face but no eyes, hands but no arms. What am I?',o:['A statue','A clock','A map','A mirror'],a:'A clock'},
      {t:'math',q:'What is 8¬≤?',v:'8¬≤=?',o:['56','60','64','68'],a:'64'},
      {t:'logic',q:'How many legs do 3 dogs and 2 spiders have?',o:['24','28','26','22'],a:'28'},
      {t:'math',q:'What is 33 + 48?',v:'33+48=?',o:['79','81','82','83'],a:'81'},
      {t:'word',q:'What is the antonym of "ancient"?',o:['Old','Modern','Slow','Dark'],a:'Modern'},
      {t:'riddle',q:'What has teeth but cannot bite?',o:['A dog','A comb','A shark','A trap'],a:'A comb'},
      {t:'logic',q:'If yesterday was Wednesday, what is tomorrow?',o:['Friday','Saturday','Thursday','Sunday'],a:'Friday'},
      {t:'math',q:'What is 120 √∑ 5?',v:'120√∑5=?',o:['20','24','28','30'],a:'24'},
    ],
    medium:[
      {t:'logic',q:'If you overtake 2nd place, what place are you in?',o:['1st','2nd','3rd','Last'],a:'2nd'},
      {t:'riddle',q:"Man: 'No brothers/sisters, but this man's father is my father's son.' Who is it?",o:['Uncle','Cousin','Son','Himself'],a:'Son'},
      {t:'math',q:'If 40% of X = 120, what is X?',v:'40%√óX=120',o:['280','300','320','340'],a:'300'},
      {t:'logic',q:'Fibonacci: 1,1,2,3,5,8,?',v:'1,1,2,3,5,8,?',o:['11','12','13','14'],a:'13'},
      {t:'math',q:'What is ‚àö256?',v:'‚àö256=?',o:['14','16','18','20'],a:'16'},
      {t:'logic',q:'How many months have 28 days?',o:['1','2','6','12'],a:'12'},
      {t:'math',q:'What is 2¬π‚Å∞?',v:'2¬π‚Å∞=?',o:['512','1024','2048','4096'],a:'1024'},
      {t:'riddle',q:'I have a head and tail but no body. What am I?',o:['A snake','A coin','A kite','A river'],a:'A coin'},
      {t:'math',q:'How many squares in a 3√ó3 grid (all sizes)?',v:'3√ó3 grid',o:['9','12','14','16'],a:'14'},
      {t:'logic',q:'At 3:15, what is the angle between clock hands?',v:'üïí 3:15',o:['0¬∞','7.5¬∞','15¬∞','22.5¬∞'],a:'7.5¬∞'},
      {t:'math',q:'What is 17¬≤ ‚àí 200?',v:'17¬≤‚àí200=?',o:['87','89','91','93'],a:'89'},
      {t:'riddle',q:'The faster you run, the less you see me. What am I?',o:['Time','Wind','Feet','Breath'],a:'Breath'},
      {t:'math',q:'What is 3! + 4!?',v:'3!+4!=?',o:['24','30','36','42'],a:'30'},
      {t:'logic',q:'How many triangles in a Star of David?',v:'‚ú°',o:['6','8','12','16'],a:'8'},
      {t:'riddle',q:'What can travel the world while staying in a corner?',o:['A dream','A stamp','Internet','A shadow'],a:'A stamp'},
    ],
    hard:[
      {t:'math',q:'What is 999¬≤?',v:'999¬≤=?',o:['997001','998001','999001','996001'],a:'998001'},
      {t:'logic',q:'3 mislabeled boxes. Pull 1 from "Mixed". Identify all 3?',o:['Yes, always','No, never','Sometimes','Need 2'],a:'Yes, always'},
      {t:'riddle',q:'I am the beginning of everything, the end of everywhere. What am I?',o:['Zero','Letter E','Infinity','Nothing'],a:'Letter E'},
      {t:'math',q:'How many trailing zeros does 100! have?',v:'100!=?00...',o:['20','22','24','26'],a:'24'},
      {t:'math',q:'Prime number between 90 and 100?',v:'90<P<100',o:['91','93','97','99'],a:'97'},
      {t:'logic',q:'f(x)=x¬≤+2x+1. What is f(5)?',v:'f(5)=?',o:['34','36','38','40'],a:'36'},
      {t:'math',q:'What is 7!?',v:'7!=?',o:['2520','4040','5040','6040'],a:'5040'},
      {t:'math',q:'Sum of interior angles of a hexagon?',v:'Hexagon',o:['540¬∞','660¬∞','720¬∞','840¬∞'],a:'720¬∞'},
      {t:'math',q:'What is 1+2+3+...+100?',v:'Œ£(1‚Üí100)=?',o:['4950','5000','5050','5100'],a:'5050'},
      {t:'math',q:'What is i¬≤ where i=‚àö(‚àí1)?',v:'i¬≤=?',o:['1','0','-1','i'],a:'-1'},
      {t:'logic',q:'Half the island always lies. Ask if they are a liar. Answer?',o:['Yes','No','I don\'t know','It depends'],a:'No'},
      {t:'riddle',q:'3 doctors say Pedro is their brother. Pedro has no brothers. Who lies?',o:['The doctors','Pedro','Both','Nobody'],a:'Nobody'},
      {t:'math',q:'What is 17¬≤?',v:'17¬≤=?',o:['279','289','299','309'],a:'289'},
      {t:'riddle',q:'Father has 5 children, half are daughters. How?',o:['Impossible','All daughters','Only 2 daughters','Math error'],a:'All daughters'},
      {t:'math',q:'What is log‚ÇÇ(1024)?',v:'log‚ÇÇ(1024)=?',o:['8','10','12','16'],a:'10'},
    ]
  }
};
PZ.fr = PZ.es; PZ.de = PZ.en;

// ============================================================
// CONFIG
// ============================================================
const TMAX    = {easy:30, medium:20, hard:13};
const TBONUS  = {easy:8,  medium:6,  hard:5};
const PBASE   = {easy:100,medium:220,hard:450};
const SPEEDPT = 4;
const COLORS  = ['#f0ff44','#ff4466','#44ffcc','#ff8844','#a78bfa','#38bdf8','#fb923c','#4ade80'];

// ============================================================
// STATE
// ============================================================
let pName='', lang='es', diff='easy', mode='classic';
let score=0, lives=3, streak=0, maxStreak=0, curQ=0, numOk=0;
let answered=false, puzzles=[], gameActive=false;
let startTime=0, qStartTime=0;
let timeLeft=0, timerInt=null;
const MAX_T=30;
let lbTab='all', cachedScores=[];

// ============================================================
// UI
// ============================================================
function setLang(l){ lang=l; document.querySelectorAll('.lpill').forEach((b,i)=>b.classList.toggle('active',['es','en','fr','de'][i]===l)); }
function setDiff(d){ diff=d; document.querySelectorAll('.dchip').forEach(b=>b.classList.remove('active')); document.querySelector(`.dchip[data-d="${d}"]`).classList.add('active'); }
function selMode(m){ mode=m; document.querySelectorAll('.mcard').forEach(c=>c.classList.toggle('sel',c.dataset.m===m)); }
function onName(){ pName=document.getElementById('ninput').value.trim(); document.getElementById('start-btn').disabled=!pName; }
function showScreen(id){ document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
function goHome(){ clearInterval(timerInt); gameActive=false; showScreen('home-screen'); }
function quitGame(){ if(confirm('¬øSeguro?')){ clearInterval(timerInt); gameActive=false; showScreen('home-screen'); } }
function nameColor(n){ let h=0; for(let c of n) h=(h*31+c.charCodeAt(0))%COLORS.length; return COLORS[h]; }
function escHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function openModal(){ document.getElementById('sql-modal').classList.add('show'); }
function closeModal(){ document.getElementById('sql-modal').classList.remove('show'); }

let bannerTO;
function setBanner(cls,txt,dur=0){
  const el=document.getElementById('banner');
  el.textContent=txt; el.className='banner '+cls;
  clearTimeout(bannerTO);
  if(dur) bannerTO=setTimeout(()=>el.className='banner',dur);
}

// ============================================================
// GAME START
// ============================================================
function startGame(){
  score=0; lives=3; streak=0; maxStreak=0; curQ=0; numOk=0;
  answered=false; gameActive=true; startTime=Date.now();

  const pool=[...(PZ[lang]||PZ.es)[diff]];
  for(let i=pool.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]]; }
  puzzles = mode==='infinite' ? pool : pool.slice(0,10);

  const col=nameColor(pName);
  document.getElementById('pav').style.background=col;
  document.getElementById('pav').textContent=pName[0].toUpperCase();
  document.getElementById('pname-d').textContent=pName;
  document.getElementById('pmode-d').textContent=(mode==='infinite'?'‚ôæÔ∏è Infinito':'üéØ Cl√°sico')+' ¬∑ '+{easy:'F√°cil',medium:'Medio',hard:'Dif√≠cil'}[diff];

  const inf=mode==='infinite';
  document.getElementById('tcont').style.display=inf?'block':'none';
  document.getElementById('cprog').style.display=inf?'none':'block';
  document.getElementById('lives-block').style.display=inf?'none':'flex';

  if(inf){ timeLeft=MAX_T; startTimer(); }
  else buildDots();

  showScreen('game-screen');
  loadPuzzle();
}

// ============================================================
// TIMER
// ============================================================
function startTimer(){
  clearInterval(timerInt);
  timerInt=setInterval(()=>{
    if(!gameActive){clearInterval(timerInt);return;}
    timeLeft=Math.max(0,timeLeft-0.1);
    renderTimer();
    if(timeLeft<=0){clearInterval(timerInt);endGame();}
  },100);
}
function renderTimer(){
  const pct=(timeLeft/MAX_T)*100;
  const fill=document.getElementById('tfill'), val=document.getElementById('tval-d');
  fill.style.width=Math.min(pct,150)+'%';
  val.textContent=timeLeft.toFixed(1)+'s';
  const cls=pct>40?'ok':pct>20?'warn':'danger';
  fill.className='tfill '+cls; val.className='tval '+cls;
}
function addTime(s){
  timeLeft=Math.min(timeLeft+s,MAX_T*1.8);
  const el=document.getElementById('tadd');
  el.textContent=`+${s}s ‚è±`; el.className='tadd show';
  setTimeout(()=>el.className='tadd',1000);
}

// ============================================================
// Q DOTS
// ============================================================
function buildDots(){
  const c=document.getElementById('qdots'); c.innerHTML='';
  for(let i=0;i<10;i++){ const d=document.createElement('div'); d.className='qdot'+(i===0?' cur':''); c.appendChild(d); }
}
function updateDots(results){
  document.querySelectorAll('.qdot').forEach((d,i)=>{
    d.className='qdot';
    if(i<curQ) d.classList.add(results[i]==='ok'?'done':'bad');
    else if(i===curQ) d.classList.add('cur');
  });
  document.getElementById('qlabel').textContent=`Pregunta ${curQ+1}/10`;
  document.getElementById('qcorrect').textContent=`${numOk} correctas`;
}

// ============================================================
// LOAD PUZZLE
// ============================================================
const qResults=[];
function loadPuzzle(){
  answered=false; qStartTime=Date.now();

  if(mode==='infinite' && curQ>=puzzles.length){
    const pool=[...(PZ[lang]||PZ.es)[diff]];
    for(let i=pool.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[pool[i],pool[j]]=[pool[j],pool[i]];}
    puzzles.push(...pool);
  }

  const p=puzzles[curQ]; if(!p){endGame();return;}
  const types={math:'üî¢ Matem√°ticas',logic:'üß† L√≥gica',word:'üìù Palabras',visual:'üëÅÔ∏è Visual',riddle:'üé≠ Acertijo'};
  document.getElementById('tbadge').textContent=types[p.t]||p.t;
  document.getElementById('qnum-badge').textContent=mode==='infinite'?`#${curQ+1}`:'';
  document.getElementById('pq').textContent=p.q;
  const vis=document.getElementById('pvis');
  if(p.v){vis.textContent=p.v;vis.style.display='block';}else{vis.style.display='none';}

  const opts=document.getElementById('opts'); opts.innerHTML='';
  const letters=['A','B','C','D'];
  [...p.o].sort(()=>Math.random()-.5).forEach((opt,i)=>{
    const btn=document.createElement('button');
    btn.className='opt';
    btn.innerHTML=`<span class="olet">${letters[i]}</span>${escHtml(opt)}`;
    btn.onclick=()=>checkAnswer(opt,btn,p.a);
    opts.appendChild(btn);
  });

  updateStreak();
  if(mode==='classic') updateDots(qResults);

  const card=document.getElementById('pcard');
  card.style.opacity='0'; card.style.transform='translateY(16px)';
  requestAnimationFrame(()=>{ card.style.transition='all .22s ease-out'; card.style.opacity='1'; card.style.transform='translateY(0)'; });
}

// ============================================================
// CHECK ANSWER
// ============================================================
function checkAnswer(sel,btn,correct){
  if(answered) return;
  answered=true;
  const isOk=sel===correct;
  const elapsed=(Date.now()-qStartTime)/1000;

  document.querySelectorAll('.opt').forEach(b=>{
    b.disabled=true;
    if(b.textContent.slice(1).trim()===correct) b.classList.add('correct');
  });
  if(!isOk) btn.classList.add('wrong');

  if(isOk){
    numOk++; qResults[curQ]='ok';
    streak++; if(streak>maxStreak) maxStreak=streak;
    const mult=getMult();
    const spd=mode==='classic'?Math.round(Math.max(0,(TMAX[diff]-elapsed))*SPEEDPT):0;
    const pts=Math.round((PBASE[diff]+spd)*mult);
    score+=pts;
    document.getElementById('score-d').textContent=score.toLocaleString();
    if(mode==='infinite') addTime(TBONUS[diff]+(streak>=5?3:streak>=3?1:0));
    spawnPop(`+${pts}${mult>1?' √ó'+mult:''}`);
    showToast(`‚úì +${pts}${mult>1?' üî•√ó'+mult:''}`,true);
    if(streak===3) showCombo('üî• TRIPLE!');
    else if(streak===5) showCombo('üí• √ó5 COMBO!');
    else if(streak===10) showCombo('üëë √ó10 LEYENDA!');
    else if(streak>10&&streak%5===0) showCombo(`‚ö° √ó${streak} RACHA!`);
  } else {
    qResults[curQ]='bad'; streak=0;
    if(mode==='classic'){
      lives=Math.max(0,lives-1);
      document.getElementById('lives-d').textContent='‚ù§Ô∏è'.repeat(lives)+'üñ§'.repeat(3-lives);
    }
    showToast(`‚úó Era: ${correct}`,false);
  }

  updateStreak();
  if(mode==='classic') updateDots(qResults);

  setTimeout(()=>{
    curQ++;
    if(mode==='classic'&&(lives<=0||curQ>=10)){endGame();return;}
    loadPuzzle();
  },900);
}

// ============================================================
// STREAK
// ============================================================
function getMult(){ return streak>=10?4:streak>=7?3:streak>=5?2.5:streak>=3?2:1; }
function updateStreak(){
  document.getElementById('slabel').textContent=`Racha: ${streak}`;
  document.getElementById('sbar').classList.toggle('hot',streak>=3);
  document.getElementById('sfire').textContent=streak>=5?'üí•':streak>=3?'üî•':'‚ú®';
  const mult=getMult();
  const me=document.getElementById('smult');
  me.textContent=mult>1?`√ó${mult}`:''; me.classList.toggle('show',mult>1);
  document.querySelectorAll('.sdot').forEach((d,i)=>{
    d.className='sdot';
    if(i<streak%5){d.classList.add('lit');if(mult>1)d.classList.add('bonus');}
  });
}

// ============================================================
// EFFECTS
// ============================================================
function showCombo(txt){
  const el=document.getElementById('combo-ov');
  document.getElementById('ctxt').textContent=txt;
  el.className='combo-ov'; void el.offsetWidth; el.classList.add('show');
  setTimeout(()=>el.classList.remove('show'),1600);
}
let toastTO;
function showToast(msg,ok){
  const el=document.getElementById('toast'); clearTimeout(toastTO);
  el.textContent=msg; el.className='toast show '+(ok?'ok':'err');
  toastTO=setTimeout(()=>el.classList.remove('show'),1400);
}
function spawnPop(txt){
  const p=document.createElement('div'); p.className='spop';
  p.textContent=txt; p.style.cssText='color:#f0ff44;left:50%;top:38%;transform:translateX(-50%)';
  document.body.appendChild(p); setTimeout(()=>p.remove(),1200);
}

// ============================================================
// END GAME + SAVE
// ============================================================
async function endGame(){
  clearInterval(timerInt); gameActive=false;
  const elapsed=Math.round((Date.now()-startTime)/1000);
  const entry={name:pName,score,correct:numOk,total:curQ,mode,diff,streak:maxStreak,time:elapsed,ts:Date.now()};

  setBanner('saving','üíæ Guardando puntuaci√≥n...');
  const ok=await SB.insert(entry);
  if(ok) setBanner('online','‚úÖ ¬°Puntuaci√≥n guardada en el ranking!',3000);
  else    setBanner('offline','‚ö†Ô∏è Error al guardar ‚Äî comprueba que la tabla existe (bot√≥n "Setup DB")',5000);

  // Show results
  document.getElementById('remi').textContent=score>3000?'üëë':lives>0?'üèÜ':'üíÄ';
  document.getElementById('rtitle').textContent=lives<=0?'¬°GAME OVER!':mode==='infinite'?'¬°TIEMPO!':'¬°COMPLETADO!';
  document.getElementById('rtitle').className='rtitle '+(lives<=0?'over':'win');
  document.getElementById('rsub').textContent=`${pName} ¬∑ ${mode==='infinite'?'‚ôæÔ∏è Infinito':'üéØ Cl√°sico'} ¬∑ ${{easy:'F√°cil',medium:'Medio',hard:'Dif√≠cil'}[diff]}`;
  document.getElementById('rs-score').textContent=score.toLocaleString();
  document.getElementById('rs-correct').textContent=mode==='classic'?`${numOk}/10`:numOk;
  document.getElementById('rs-streak').textContent=maxStreak;
  document.getElementById('rs-extra').textContent=mode==='infinite'?`${numOk}‚úì`:`${elapsed}s`;
  document.getElementById('rs-extra-lbl').textContent=mode==='infinite'?'Acertadas':'Tiempo';

  // Rank
  const top=await SB.fetchTop(mode,diff)||[];
  const best={};
  top.forEach(e=>{ const k=e.name; if(!best[k]||e.score>best[k].score) best[k]=e; });
  const sorted=Object.values(best).sort((a,b)=>b.score-a.score);
  const rank=sorted.findIndex(e=>e.name===pName&&e.score===score)+1||sorted.length+1;
  document.getElementById('rr-num').textContent=`#${rank}`;
  document.getElementById('rr-title').textContent=rank===1?'¬°Primer puesto! üëë':rank<=3?`¬°Top ${rank}! üèÖ`:`Posici√≥n #${rank}`;
  document.getElementById('rr-sub').textContent=`ranking ${mode} ¬∑ ${diff}`;

  showScreen('results-screen');
}

// ============================================================
// LEADERBOARD
// ============================================================
async function showLB(){
  showScreen('lb-screen');
  await loadLB();
}
async function loadLB(){
  document.getElementById('lblist').innerHTML='<div class="lb-loading">Cargando ranking</div>';
  const mf = lbTab==='classic'||lbTab==='infinite' ? lbTab : null;
  const df = lbTab==='easy'||lbTab==='hard' ? lbTab : null;
  const data=await SB.fetchTop(mf,df);
  if(!data){
    document.getElementById('lblist').innerHTML='<div class="lb-empty">‚ö†Ô∏è No se pudo cargar.<br>Crea la tabla con el bot√≥n "Setup DB"</div>';
    return;
  }
  cachedScores=data;
  renderLB(data);
}
function switchTab(t){
  lbTab=t;
  document.querySelectorAll('.lbtab').forEach((b,i)=>b.classList.toggle('active',['all','classic','infinite','easy','hard'][i]===t));
  loadLB();
}
function renderLB(data){
  // Best per player
  const best={};
  data.forEach(e=>{ const k=`${e.name}|${e.mode}|${e.diff}`; if(!best[k]||e.score>best[k].score) best[k]=e; });
  const entries=Object.values(best).sort((a,b)=>b.score-a.score).slice(0,25);

  const list=document.getElementById('lblist'); list.innerHTML='';
  if(!entries.length){ list.innerHTML='<div class="lb-empty">Sin entradas a√∫n.<br>¬°S√© el primero en jugar! üß†</div>'; return; }

  const icons=['ü•á','ü•à','ü•â'];
  entries.forEach((e,i)=>{
    const div=document.createElement('div');
    const isMe=e.name===pName;
    div.className='lbe'+(isMe?' me':'');
    div.style.animationDelay=(i*.04)+'s';
    const col=nameColor(e.name);
    const mIcon=e.mode==='infinite'?'‚ôæÔ∏è':'üéØ';
    const dLbl={easy:'F√°cil',medium:'Medio',hard:'Dif√≠cil'}[e.diff]||e.diff||'';
    const date=new Date(e.ts||e.created_at||Date.now()).toLocaleDateString('es-ES',{day:'2-digit',month:'short'});
    div.innerHTML=`
      <div class="lrank${i<3?' r'+(i+1):''}">${i<3?icons[i]:i+1}</div>
      <div class="lav" style="background:${col};color:#000">${e.name[0].toUpperCase()}</div>
      <div class="linfo">
        <div class="lpn">${escHtml(e.name)} ${isMe?'<span class="youbadge">T√ö</span>':''}</div>
        <div class="lmeta">${mIcon} ${e.mode||''} ¬∑ ${dLbl} ¬∑ ${e.correct??'?'} ‚úì ¬∑ Racha ${e.streak??0} ¬∑ ${date}</div>
      </div>
      <div class="lsc">${(e.score||0).toLocaleString()}</div>`;
    list.appendChild(div);
  });
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('ninput').addEventListener('keydown',e=>{ if(e.key==='Enter'&&pName) startGame(); });
});
</script>
</body>
</html>
